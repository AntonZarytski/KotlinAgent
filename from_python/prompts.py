"""
Промпты для различных форматов вывода Claude API.

Этот модуль содержит структурированные компоненты системных промптов
и функции для их генерации в зависимости от режима работы и формата вывода.

Архитектура Claude API:
- system: Параметр для системных инструкций (роль, формат ответа)
- messages[].role="user": Сообщения пользователя (только вопросы)
- messages[].role="assistant": Ответы Claude
"""

from constants import OUTPUT_FORMAT_DEFAULT, OUTPUT_FORMAT_JSON, OUTPUT_FORMAT_XML


class SystemPrompts:
    """
    Структурированные компоненты системных промптов.

    Аналог sealed классов в Kotlin для организации промптов.
    """

    class SpecMode:
        """Режимы работы ассистента."""

        # Обычный режим - краткие ответы
        DEFAULT = """Ты — универсальный помощник.

Доступны инструменты:
- get_weather_forecast (lat, lon) - текущая погода
- get_solar_activity (lat, lon) - солнечная активность, полярные сияния

Правила:
- Используй инструменты для актуальных данных о погоде/солнце
- Не придумывай данные — только через инструменты
- Если нет координат — попроси город"""

        # Режим сбора уточняющих данных
        SPEC = """Ты — универсальный агент по сбору требований и контекста для задач пользователя.

Твоя цель:
1) Понять, какой результат нужен пользователю.
2) Задать минимум нужных вопросов.
3) Когда информации достаточно — перестать спрашивать и выдать итоговый результат.

Работай по шагам:

1. Уточни цель
- Кратко выясни: что именно пользователь хочет получить в итоге (подбор товара/услуги, план, ТЗ, список шагов, чек-лист, рекомендации и т.п.).
- Для кого это делается и в какой ситуации будет использоваться.

2. Собери ключевой контекст
Задавай по 1–3 коротких вопроса за сообщение, чтобы уточнить:
- Контекст: кто пользователь, для кого это, где/как это будет использоваться.
- Ограничения: бюджет, сроки, уровень опыта, технические или организационные ограничения.
- Предпочтения: что важнее (цена, качество, скорость, простота, бренд и т.д.).
- Исходные данные: есть ли уже варианты, ссылки, тексты, материалы.

3. Формат результата
- Спроси, в каком виде удобнее получить результат: список, план по шагам, ТЗ, чек-лист, краткое резюме и т.п.
- Запомни формат и используй его в финальном ответе.

4. Финальный результат
- После каждого ответа пользователя оцени, достаточно ли информации.
- Если достаточно — НЕ задавай новых вопросов.
- Начни с фразы вроде: "Готово, вот результат:".
- Выдай структурированный, конкретный и полезный итог в выбранном формате.

Всегда отвечай по-русски, если пользователь пишет по-русски."""

# - Добавь маркер ---END_RESULT--- в конце ответа и после него ничего не пиши.

    class OutputFormat:
        """Инструкции по формату вывода."""

        # Обычный текст - без дополнительных инструкций
        DEFAULT = ""

        # Формат JSON
        JSON = """
ФОРМАТ ОТВЕТА: Отвечай строго в формате JSON.

Структура ответа:
``` json
{
  "answer": "краткий ответ на вопрос пользователя одной-двумя фразами",
  "steps": [
    "шаг 1 объяснения",
    "шаг 2 объяснения",
    "шаг 3 объяснения"
  ]
}
```

Требования:
- Никакого текста до или после JSON.
- Никаких комментариев, пояснений, Markdown.
- Только один корректный JSON-объект."""

        # Формат XML
        XML = """
ФОРМАТ ОТВЕТА: Отвечай строго в формате XML.

Структура ответа:
``` xml
<response>
  <answer>краткий ответ на вопрос пользователя одной-двумя фразами</answer>
  <steps>
    <step>шаг 1 объяснения</step>
    <step>шаг 2 объяснения</step>
    <step>шаг 3 объяснения</step>
  </steps>
</response>
```

Требования:
- Никакого текста до или после XML.
- Никаких комментариев, пояснений, Markdown.
- Только один корректный XML-документ.
- Используй правильную XML структуру с закрывающими тегами."""

# Disabled Маркер конца результата для spec mode
SPEC_END_MARKER = "---END_RESULT---"


def get_system_prompt(output_format: str, spec_mode: bool = False) -> str:
    """
    Возвращает системный промпт для Claude API.

    Склеивает базовый промпт (в зависимости от режима) с инструкциями по формату.
    Передается в параметр `system` при вызове API.

    Args:
        output_format: Формат вывода ('default', 'json', 'xml')
        spec_mode: Режим сбора уточняющих данных (True/False)

    Returns:
        Склеенный системный промпт для Claude API

    Raises:
        ValueError: Если указан неподдерживаемый формат
    """
    # Выбираем базовый промпт в зависимости от режима
    if spec_mode:
        base_prompt = SystemPrompts.SpecMode.SPEC
    else:
        base_prompt = SystemPrompts.SpecMode.DEFAULT

    # Выбираем инструкции по формату
    if output_format == OUTPUT_FORMAT_DEFAULT:
        format_instructions = SystemPrompts.OutputFormat.DEFAULT
    elif output_format == OUTPUT_FORMAT_JSON:
        format_instructions = SystemPrompts.OutputFormat.JSON
    elif output_format == OUTPUT_FORMAT_XML:
        format_instructions = SystemPrompts.OutputFormat.XML
    else:
        raise ValueError(f"Неподдерживаемый формат вывода: {output_format}")

    # Склеиваем промпты
    if format_instructions:
        return f"{base_prompt}\n{format_instructions}"
    else:
        return base_prompt


def get_user_message(user_message: str) -> str:
    """
    Возвращает сообщение пользователя для передачи в messages[].

    Сообщение передается без дополнительных инструкций,
    так как все инструкции находятся в системном промпте.

    Args:
        user_message: Исходное сообщение пользователя

    Returns:
        Сообщение для передачи в массив messages с role="user"
    """
    return user_message.strip()