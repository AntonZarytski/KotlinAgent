package com.claude.agent.llm

import com.claude.agent.config.OutputFormat
import com.claude.agent.llm.mcp.ACTION_PLANNER
import com.claude.agent.llm.mcp.AIR_TICKETS
import com.claude.agent.llm.mcp.ANDROID_STUDIO_MCP
import com.claude.agent.llm.mcp.CHAT_SUMMARY
import com.claude.agent.llm.mcp.REMINDER
import com.claude.agent.llm.mcp.SOLAR
import com.claude.agent.llm.mcp.WEATHER
import java.time.ZonedDateTime
import java.time.format.DateTimeFormatter

/**
 * –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –≤—ã–≤–æ–¥–∞ Claude API.
 *
 * –ê–Ω–∞–ª–æ–≥ prompts.py –∏–∑ Python-–≤–µ—Ä—Å–∏–∏.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Kotlin object –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤.
 */

object SystemPrompts {

    /**
     * –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.
     */
    const val DEFAULT_MODE = "–¢—ã ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤."

    /**
     * –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ–∂–∏–º–∞ —Å–±–æ—Ä–∞ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (spec mode).
     */
    const val SPEC_MODE = """–¢—ã ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –ø–æ —Å–±–æ—Ä—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–¢–≤–æ—è —Ü–µ–ª—å:
1) –ü–æ–Ω—è—Ç—å, –∫–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω—É–∂–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
2) –ó–∞–¥–∞—Ç—å –º–∏–Ω–∏–º—É–º –Ω—É–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
3) –ö–æ–≥–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –∏ –≤—ã–¥–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

–†–∞–±–æ—Ç–∞–π –ø–æ —à–∞–≥–∞–º:

1. –£—Ç–æ—á–Ω–∏ —Ü–µ–ª—å
- –ö—Ä–∞—Ç–∫–æ –≤—ã—è—Å–Ω–∏: —á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –≤ –∏—Ç–æ–≥–µ (–ø–æ–¥–±–æ—Ä —Ç–æ–≤–∞—Ä–∞/—É—Å–ª—É–≥–∏, –ø–ª–∞–Ω, –¢–ó, —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤, —á–µ–∫-–ª–∏—Å—Ç, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —Ç.–ø.).
- –î–ª—è –∫–æ–≥–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –∏ –≤ –∫–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

2. –°–æ–±–µ—Ä–∏ –∫–ª—é—á–µ–≤–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
–ó–∞–¥–∞–≤–∞–π –ø–æ 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É—Ç–æ—á–Ω–∏—Ç—å:
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: –∫—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –¥–ª—è –∫–æ–≥–æ —ç—Ç–æ, –≥–¥–µ/–∫–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: –±—é–¥–∂–µ—Ç, —Å—Ä–æ–∫–∏, —É—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.
- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: —á—Ç–æ –≤–∞–∂–Ω–µ–µ (—Ü–µ–Ω–∞, –∫–∞—á–µ—Å—Ç–≤–æ, —Å–∫–æ—Ä–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ—Ç–∞, –±—Ä–µ–Ω–¥ –∏ —Ç.–¥.).
- –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã, —Å—Å—ã–ª–∫–∏, —Ç–µ–∫—Å—Ç—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã.

3. –§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- –°–ø—Ä–æ—Å–∏, –≤ –∫–∞–∫–æ–º –≤–∏–¥–µ —É–¥–æ–±–Ω–µ–µ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —Å–ø–∏—Å–æ–∫, –ø–ª–∞–Ω –ø–æ —à–∞–≥–∞–º, –¢–ó, —á–µ–∫-–ª–∏—Å—Ç, –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∏ —Ç.–ø.
- –ó–∞–ø–æ–º–Ω–∏ —Ñ–æ—Ä–º–∞—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ.

4. –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ü–µ–Ω–∏, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
- –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –ù–ï –∑–∞–¥–∞–≤–∞–π –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
- –ù–∞—á–Ω–∏ —Å —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ: "–ì–æ—Ç–æ–≤–æ, –≤–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç:".
- –í—ã–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –∏—Ç–æ–≥ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

–í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –ø–æ-—Ä—É—Å—Å–∫–∏."""

    /**
     * –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ JSON.
     */
    const val FORMAT_JSON = """
–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
``` json
{
  "answer": "–∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–π-–¥–≤—É–º—è —Ñ—Ä–∞–∑–∞–º–∏",
  "steps": [
    "—à–∞–≥ 1 –æ–±—ä—è—Å–Ω–µ–Ω–∏—è",
    "—à–∞–≥ 2 –æ–±—ä—è—Å–Ω–µ–Ω–∏—è",
    "—à–∞–≥ 3 –æ–±—ä—è—Å–Ω–µ–Ω–∏—è"
  ]
}
```

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON.
- –ù–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π, Markdown.
- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç."""

    /**
     * –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ XML.
     */
    const val FORMAT_XML = """
–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ XML.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
``` xml
<response>
  <answer>–∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–π-–¥–≤—É–º—è —Ñ—Ä–∞–∑–∞–º–∏</answer>
  <steps>
    <step>—à–∞–≥ 1 –æ–±—ä—è—Å–Ω–µ–Ω–∏—è</step>
    <step>—à–∞–≥ 2 –æ–±—ä—è—Å–Ω–µ–Ω–∏—è</step>
    <step>—à–∞–≥ 3 –æ–±—ä—è—Å–Ω–µ–Ω–∏—è</step>
  </steps>
</response>
```

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ XML.
- –ù–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π, Markdown.
- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π XML-–¥–æ–∫—É–º–µ–Ω—Ç.
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é XML —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º–∏ —Ç–µ–≥–∞–º–∏."""

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Claude API.
     *
     * @param outputFormat –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ ('default', 'json', 'xml')
     * @param specMode –†–µ–∂–∏–º —Å–±–æ—Ä–∞ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (true/false)
     * @return –°–∫–ª–µ–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
     */
    fun getSystemPrompt(outputFormat: String, enabledTools: List<String>, specMode: Boolean = false, isRagEnabled: Boolean): String {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º
        val currentTime = ZonedDateTime.now()
        val formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ssXXX")
        val formattedTime = currentTime.format(formatter)

        // –í—ã–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
        var basePrompt = if (specMode) SPEC_MODE else DEFAULT_MODE

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        basePrompt = """–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: $formattedTime

        $basePrompt"""
        if (enabledTools.isNotEmpty()) {
            var toolsPrompt = "–î–æ—Å—Ç—É–ø–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:"
            enabledTools.forEach { toolName ->
                when (toolName) {
                    ACTION_PLANNER -> toolsPrompt += "\n - $ACTION_PLANNER - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ c –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã–∑–æ–≤–∞ mcp –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ"
                    WEATHER -> toolsPrompt += "\n-$WEATHER(lat, lon) - —Ç–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞"
                    SOLAR -> toolsPrompt += "\n- $SOLAR(lat, lon) - —Å–æ–ª–Ω–µ—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –ø–æ–ª—è—Ä–Ω—ã–µ —Å–∏—è–Ω–∏—è"
                    REMINDER -> toolsPrompt += """–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç:
                                                    - –Ω–∞–ø–æ–º–Ω–∏—Ç—å
                                                    - —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                                                    - —É–≤–µ–¥–æ–º–∏—Ç—å –≤ –±—É–¥—É—â–µ–º
                                                    
                                                    –¢—ã –æ–±—è–∑–∞–Ω –≤—ã–∑–≤–∞—Ç—å MCP tool $REMINDER —Å action="add"."""
                    CHAT_SUMMARY -> toolsPrompt += "\n- $CHAT_SUMMARY - –ø–æ–ª—É—á–∏—Ç—å –∫—Ä–∞—Ç–∫–æ–µ summary —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞"
                    AIR_TICKETS -> toolsPrompt += "\n- $AIR_TICKETS remote MCP - –ü–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–µ—Ä–µ–ª—ë—Ç–æ–≤ —Å —É—á—ë—Ç–æ–º –º–∞—Ä—à—Ä—É—Ç–∞, –¥–∞—Ç (–≤–∫–ª—é—á–∞—è –≥–∏–±–∫–æ—Å—Ç—å ¬±3 –¥–Ω—è), —Ç–∏–ø–∞ –ø–æ–µ–∑–¥–∫–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –∏ –∫–ª–∞—Å—Å–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è."
                    ANDROID_STUDIO_MCP -> toolsPrompt += "\n- $ANDROID_STUDIO_MCP remote MCP - –ü–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —ç–º—É–ª—è—Ç–æ—Ä–æ–º Android Studio –∏ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã ADB –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞."
                }
            }
            toolsPrompt += """

            –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í:

            1. –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨:
               - –í—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞—á–∏ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û –∏ –¶–ï–õ–ï–ù–ê–ü–†–ê–í–õ–ï–ù–ù–û
               - –ù–ï –∑–∞—Ü–∏–∫–ª–∏–≤–∞–π—Å—è –Ω–∞ –æ–¥–Ω–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π)
               - –ï—Å–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª 2-3 —É—Ä–æ–≤–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π - –ü–ï–†–ï–•–û–î–ò –∫ —á—Ç–µ–Ω–∏—é —Ñ–∞–π–ª–æ–≤
               - –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Å—Ç–µ–π - –≤—ã–ø–æ–ª–Ω–∏ –í–°–ï —á–∞—Å—Ç–∏

            2. –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï:
               - –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á –°–ù–ê–ß–ê–õ–ê –∏—Å–ø–æ–ª—å–∑—É–π $ACTION_PLANNER
               - –°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –∏–∑ 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–æ–≤
               - –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω—è–π —à–∞–≥–∏ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û

            3. –†–ê–ë–û–¢–ê –° –§–ê–ô–õ–ê–ú–ò (android_studio):
               - browse_files: –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –ë–´–°–¢–†–û–ì–û –æ–±–∑–æ—Ä–∞ (1-2 —É—Ä–æ–≤–Ω—è)
               - read_file: –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –ß–¢–ï–ù–ò–Ø —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–æ–≤
               - –ù–ï –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π –∫–∞–∂–¥—É—é –ø–∞–ø–∫—É —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ - —ç—Ç–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
               - –ï—Å–ª–∏ –Ω—É–∂–Ω–æ "–ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–µ–∫—Ç" - –ø—Ä–æ—á–∏—Ç–∞–π –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã (MainActivity, build.gradle, AndroidManifest.xml)

            4. –ó–ê–í–ï–†–®–ï–ù–ò–ï –ó–ê–î–ê–ß:
               - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "—Å–¥–µ–ª–∞—Ç—å X –∏ Y" - —Å–¥–µ–ª–∞–π –û–ë–ê –¥–µ–π—Å—Ç–≤–∏—è
               - –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω–µ –∑–∞–¥–∞—á–∏
               - –°–æ–æ–±—â–∏ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –í–°–ï–• —á–∞—Å—Ç–µ–π –∑–∞–¥–∞—á–∏

            5. –î–ê–ù–ù–´–ï:
               - –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ/—Å–æ–ª–Ω—Ü–µ/–∞–≤–∏–∞–±–∏–ª–µ—Ç–∞—Ö
               - –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
               - –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî –ø–æ–ø—Ä–æ—Å–∏ –≥–æ—Ä–æ–¥
            """
            basePrompt += "\n$toolsPrompt"
        }

        if (isRagEnabled) {
            val ragPrompt = """

–í–ê–ñ–ù–û: –†–ê–ë–û–¢–ê –° –ö–û–ù–¢–ï–ö–°–¢–û–ú –ò–ó –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò (RAG):

–í–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Å–≤–æ–µ–º –æ—Ç–≤–µ—Ç–µ
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: "–°–æ–≥–ª–∞—Å–Ω–æ [–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞]..." –∏–ª–∏ "–í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ [—Ñ–∞–π–ª]..."
3. –í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ü–∏—é "üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:" —Å–æ —Å–ø–∏—Å–∫–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
4. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —Å–∫–∞–∂–∏—Ç–µ ¬´–í –º–æ–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç —Ç–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö¬ª

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê –° –ò–°–¢–û–ß–ù–ò–ö–ê–ú–ò:
[–í–∞—à –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...]

üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
- [–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ 1]
- [–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ 2]

–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏!
            """.trimIndent()
            basePrompt += "\n$ragPrompt"
        }

        // –í—ã–±–∏—Ä–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ñ–æ—Ä–º–∞—Ç—É
        val formatInstructions = when (outputFormat) {
            OutputFormat.JSON -> FORMAT_JSON
            OutputFormat.XML -> FORMAT_XML
            else -> ""
        }

        // –°–∫–ª–µ–∏–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã
        return if (formatInstructions.isNotBlank()) {
            "$basePrompt\n$formatInstructions"
        } else {
            basePrompt
        }
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π).
     */
    fun getUserMessage(userMessage: String): String {
        return userMessage.trim()
    }
}