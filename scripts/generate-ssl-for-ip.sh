#!/bin/bash

# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ° Ğ´Ğ»Ñ IP Ğ°Ğ´Ñ€ĞµÑĞ°
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ./generate-ssl-for-ip.sh [IP_ADDRESS]

set -e

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
OUTPUT_FILE="$PROJECT_DIR/ktor.p12"
PASSWORD="changeit"

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘   Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ° Ğ´Ğ»Ñ IP Ğ°Ğ´Ñ€ĞµÑĞ°             â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ IP Ğ°Ğ´Ñ€ĞµÑĞ°
if [ -z "$1" ]; then
    echo -e "${YELLOW}IP Ğ°Ğ´Ñ€ĞµÑ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½. ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ...${NC}"
    
    # ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ IP
    PUBLIC_IP=$(curl -s ifconfig.me || curl -s icanhazip.com || echo "")
    
    if [ -z "$PUBLIC_IP" ]; then
        # ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ IP
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            LOCAL_IP=$(ipconfig getifaddr en0 || ipconfig getifaddr en1 || echo "127.0.0.1")
        else
            # Linux
            LOCAL_IP=$(hostname -I | awk '{print $1}' || echo "127.0.0.1")
        fi
        IP_ADDRESS=$LOCAL_IP
    else
        IP_ADDRESS=$PUBLIC_IP
    fi
    
    echo -e "${GREEN}ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½ IP Ğ°Ğ´Ñ€ĞµÑ: $IP_ADDRESS${NC}"
    echo -e "${YELLOW}Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ IP, Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ: $0 YOUR_IP${NC}"
    echo ""
    read -p "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ IP $IP_ADDRESS? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾${NC}"
        exit 1
    fi
else
    IP_ADDRESS=$1
fi

echo ""
echo "IP Ğ°Ğ´Ñ€ĞµÑ: $IP_ADDRESS"
echo "ĞŸÑ€Ğ¾ĞµĞºÑ‚: $PROJECT_DIR"
echo "Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ»: $OUTPUT_FILE"
echo ""

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

echo -e "${YELLOW}[1/4] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ OpenSSL...${NC}"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ° Ñ SAN (Subject Alternative Name)
cat > openssl-san.cnf << EOF
[req]
default_bits = 4096
prompt = no
default_md = sha256
distinguished_name = dn
req_extensions = v3_req
x509_extensions = v3_ca

[dn]
C=RU
ST=Moscow
L=Moscow
O=KotlinAgent
OU=Development
CN=$IP_ADDRESS

[v3_req]
subjectAltName = @alt_names
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth

[v3_ca]
subjectAltName = @alt_names
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth

[alt_names]
IP.1 = $IP_ADDRESS
IP.2 = 127.0.0.1
DNS.1 = localhost
EOF

echo -e "${GREEN}âœ… ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°${NC}"

echo -e "${YELLOW}[2/4] Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ»ÑÑ‡Ğ° Ğ¸ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°...${NC}"

# Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ»ÑÑ‡Ğ° Ğ¸ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°
openssl req -new -x509 -nodes -days 365 \
    -keyout server.key \
    -out server.crt \
    -config openssl-san.cnf \
    -extensions v3_ca

echo -e "${GREEN}âœ… Ğ¡ĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ (Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½ 365 Ğ´Ğ½ĞµĞ¹)${NC}"

echo -e "${YELLOW}[3/4] ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ PKCS12...${NC}"

# ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² PKCS12 Ğ´Ğ»Ñ Ktor
openssl pkcs12 -export \
    -in server.crt \
    -inkey server.key \
    -out ktor.p12 \
    -name ktor \
    -passout pass:$PASSWORD

echo -e "${GREEN}âœ… ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°${NC}"

echo -e "${YELLOW}[4/4] ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²...${NC}"

# ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
cp ktor.p12 "$OUTPUT_FILE"
cp server.crt "$PROJECT_DIR/server.crt"
cp server.key "$PROJECT_DIR/server.key"

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
chmod 600 "$OUTPUT_FILE"
chmod 600 "$PROJECT_DIR/server.key"

# ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°
cd "$PROJECT_DIR"
rm -rf "$TEMP_DIR"

echo -e "${GREEN}âœ… Ğ¤Ğ°Ğ¹Ğ»Ñ‹ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹${NC}"

# Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘              SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½!                    â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${GREEN}Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹:${NC}"
echo "  ğŸ“„ $OUTPUT_FILE (PKCS12 Ğ´Ğ»Ñ Ktor)"
echo "  ğŸ“„ $PROJECT_DIR/server.crt (Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚)"
echo "  ğŸ“„ $PROJECT_DIR/server.key (Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡)"
echo ""
echo -e "${YELLOW}ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:${NC}"
echo "  IP Ğ°Ğ´Ñ€ĞµÑ: $IP_ADDRESS"
echo "  ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ: $PASSWORD"
echo "  ĞĞ»Ğ¸Ğ°Ñ: ktor"
echo "  Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ: 365 Ğ´Ğ½ĞµĞ¹"
echo ""
echo -e "${YELLOW}Ğ’Ğ°Ñˆ ÑĞµÑ€Ğ²ĞµÑ€ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ:${NC}"
echo -e "  ${GREEN}https://$IP_ADDRESS:8443${NC}"
echo ""
echo -e "${YELLOW}âš ï¸  Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµÑ‚ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸${NC}"
echo ""
echo -e "${BLUE}ĞšĞ°Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ Ğ² Ğ´Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğµ:${NC}"
echo ""
echo -e "${YELLOW}macOS:${NC}"
echo "  sudo security add-trusted-cert -d -r trustRoot \\"
echo "    -k /Library/Keychains/System.keychain $PROJECT_DIR/server.crt"
echo ""
echo -e "${YELLOW}Linux:${NC}"
echo "  sudo cp $PROJECT_DIR/server.crt /usr/local/share/ca-certificates/kotlinagent.crt"
echo "  sudo update-ca-certificates"
echo ""
echo -e "${YELLOW}Windows:${NC}"
echo "  certutil -addstore \"Root\" $PROJECT_DIR/server.crt"
echo ""
echo -e "${BLUE}Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸:${NC}"
echo "1. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ: ./gradlew :app:run"
echo "2. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ: https://$IP_ADDRESS:8443"
echo "3. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ Ğ² Ğ´Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğµ (ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ²Ñ‹ÑˆĞµ)"
echo ""

